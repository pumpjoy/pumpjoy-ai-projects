<!DOCTYPE html>
<html>
<head>
    <title>Stock Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.2.1/dist/chart.min.js"></script> 
</head>
<body>
    <h1>Simple Stock Tracker</h1>
    <form id="stock-form">
        {% csrf_token %}
        <label for="symbol-input">Enter Stock Symbol:</label>
        <input type="text" id="symbol-input" name="symbol" placeholder="e.g., AAPL, GOOGL" required>
        <button type="submit">Submit</button>
    </form>

    <div id="chart-container">
        <canvas id="myStockChart"></canvas>
    </div>

    <script>
        const form = document.getElementById('stock-form');
        const chartCtx = document.getElementById('myStockChart').getContext('2d');
        let stockChart = null; // Store chart instance

        form.addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent default form submission

            const symbol = document.getElementById('symbol-input').value;
            const formData = new FormData(form);

            fetch('/', { // Submitting to the same URL ('/')
                method: 'POST',
                body: formData,
            })
            .then(response => {
                if (!response.ok) {
                    // Read error message from the JSON response
                    return response.json().then(err => {
                        throw new Error(err.error || `HTTP Error: ${response.status}`);
                    }).catch(()=> {
                        // If response is not JSON (e.g., Django HTML error page)
                        throw new Error(`Server returned status ${response.status}. Check Django console.`);
                    });
                }
                return response.json();
            })
            .then(data => {
                // Check for specific error from backend
                if (data.error) {
                    alert('Error fetching data: ' + data.error);
                    return;
                }

                // Destroy previous chart instance if exists
                if (stockChart) {
                    stockChart.destroy();
                }

                // Draw new chart
                stockChart = new Chart(chartCtx, {
                    type: 'line',
                    data: {
                        labels: data.dates,
                        datasets: [
                            {
                                label: `${data.symbol} Adjusted Close`,
                                data: data.adj_close_prices,
                                borderColor: 'rgb(75, 192, 192)', // Cyan line for price
                                borderWidth: 2,
                                pointRadius: 0, // Hide points for a cleaner look
                                tension: 0.1
                            },
                            {
                                label: '50-Day SMA',
                                data: data.sma_prices,
                                borderColor: 'rgb(255, 99, 132)', // Red line for SMA
                                borderWidth: 2,
                                pointRadius: 0,
                                tension: 0.1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: `Stock Price and 50-Day SMA for ${data.symbol}`
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Price (USD)'
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Fetch error:', error);
                alert('An error occurred: ' + error.message);
            });
        });
    </script>
</body>
</html>